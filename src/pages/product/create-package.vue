<script setup lang="ts">
import { useWindowScroll } from '@vueuse/core'
import { computed, reactive, ref } from 'vue'
import { useHead } from '@vueuse/head'
import { activeSidebar, toggleSidebar } from '/@src/state/activeSidebarState'
import useCreatePackage from '/@src/composable/package/use-create-package'
import { pageTitle } from '/@src/state/sidebarLayoutState'

pageTitle.value = 'Package Management'

useHead({
  title: 'Whitehouse Group Package',
})

const showDependOnSelector = ref(false)
const {
  addonPackages,
  addMainPackage,
  currentAddonPackage,
  createPackageGroup,
  dependOnPackageList,
  displayPackageNameById,
  displayPackageImageById,
  isLoadingPackages,
  mainIdx,
  mainPackage,
  generateTicket,
  packages,
  addAddonPackage,
  showAddonSection,
  removePackage,
  showMainPackageSection,
  toggleShowAddonPackageSection,
  toggleShowMainPackageSection,
} = useCreatePackage()

const { y } = useWindowScroll()
const isStuck = computed(() => {
  return y.value > 30
})

const swapOrderIndex = () => {
  addonPackages.value = addonPackages.value.map((addon, index) => {
    return { ...addon, idx: index + 1 }
  })
}
</script>

<template>
  <div class="page-content-inner">
    <!-- create group package -->
    <div class="form-layout is-stacked">
      <V-Tabs
        selected="package-group"
        :tabs="[
          { label: 'Package', value: 'package' },
          { label: 'Package Group', value: 'package-group' },
        ]"
      >
        <template #tab="{ activeValue }">
          <p v-if="activeValue === 'package'">Create normal package</p>
          <p v-else-if="activeValue === 'package-group'">
            <V-Loader
              size="small"
              lighter
              grey
              translucent
              :active="isLoadingPackages"
            >
              <div class="form-outer">
                <div
                  :class="[isStuck && 'is-stuck']"
                  class="form-header stuck-header"
                >
                  <div class="form-header-inner">
                    <div class="left">
                      <h3>Create Package Group</h3>
                    </div>
                    <div class="right">
                      <div class="buttons">
                        <V-Button
                          icon="lnir lnir-arrow-left rem-100"
                          light
                          dark-outlined
                        >
                          Cancel
                        </V-Button>
                        <V-Button
                          color="primary"
                          raised
                          @click="createPackageGroup"
                        >
                          Create
                        </V-Button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-body">
                  <div
                    v-show="addonPackages.length && !showMainPackageSection"
                    class="form-section is-grey"
                  >
                    <VueDraggable
                      v-model="addonPackages"
                      :disabled="showMainPackageSection || showAddonSection"
                      item-key="packageId"
                      class="list-group"
                      ghost-class="ghost"
                      @change="swapOrderIndex"
                    >
                      <template #item="{ element: addon }">
                        <V-CardAction
                          :avatar="displayPackageImageById(addon.packageId)"
                          :title="`[idx: ${addon.idx}] (id: ${
                            addon.packageId
                          }) ${displayPackageNameById(addon.packageId)}`"
                          :subtitle="
                            addon.type === 'main'
                              ? 'Main Package'
                              : 'Addon Package'
                          "
                          class="package-row-drag"
                        >
                          <template #action>
                            <V-IconBox
                              v-if="addon.type === 'main'"
                              size="small"
                              color="primary"
                              rounded
                              class="mr-3"
                            >
                              <i class="iconify" data-icon="feather:flag"></i>
                            </V-IconBox>
                            <template
                              v-if="
                                !(showMainPackageSection || showAddonSection)
                              "
                            >
                              <V-Button
                                v-if="addon.type === 'main'"
                                elevated
                                @click="toggleShowMainPackageSection"
                                >Edit</V-Button
                              >
                              <V-Button
                                v-else
                                elevated
                                @click="toggleShowAddonPackageSection(addon)"
                                >Edit</V-Button
                              >
                              <V-Button
                                v-if="addon.type === 'addon'"
                                color="danger"
                                elevated
                                class="ml-3"
                                @click="removePackage(addon.idx)"
                                >Remove</V-Button
                              >
                            </template>
                          </template>
                          <div class="package-detail">
                            <V-Snack
                              v-if="addon.generateTicket === '1'"
                              title="Generate Ticket"
                              color="success"
                              white
                              solid
                              icon="feather:plus-circle"
                            >
                              <div></div>
                            </V-Snack>
                            <V-Snack
                              v-if="addon.generateTicket === '0'"
                              title="Not Generate Ticket"
                              color="danger"
                              white
                              solid
                              icon="feather:minus-circle"
                            >
                              <div></div>
                            </V-Snack>

                            <V-Snack
                              v-if="addon.dependonPackageId"
                              :title="
                                displayPackageNameById(addon.dependonPackageId)
                              "
                              color="warning"
                              white
                              solid
                              icon="feather:alert-triangle"
                              class="ml-3"
                            >
                              <!-- <i class="iconify" data-icon="feather:minus"></i> -->
                              <div></div>
                            </V-Snack>

                            <V-Snack
                              v-if="addon.dependonTicketUse"
                              :title="`Ticket Used: ${addon.dependonTicketUse}`"
                              color="success"
                              white
                              solid
                              icon="feather:hash"
                              class="ml-3"
                            >
                              <!-- <i class="iconify" data-icon="feather:hash"></i> -->
                              <div></div>
                            </V-Snack>
                          </div>
                        </V-CardAction>
                      </template>
                    </VueDraggable>
                    <div class="p-3 right">
                      <V-Button @click="toggleShowAddonPackageSection"
                        >Add addon package</V-Button
                      >
                    </div>
                  </div>

                  <!-- Main package section -->
                  <div v-if="showMainPackageSection" class="form-fieldset">
                    <div class="fieldset-heading">
                      <h4>Main Package</h4>
                      <p>Select main package</p>
                    </div>
                    <div class="columns is-multiline">
                      <div class="column is-12">
                        <V-Field>
                          <label>Main Package</label>
                          <V-Control>
                            <Multiselect
                              v-model="mainPackage"
                              placeholder="Select a main package"
                              :options="packages"
                              :searchable="true"
                              track-by="packageName"
                              value-prop="id"
                            >
                              <template #singlelabel="{ value }">
                                <div class="multiselect-single-label">
                                  ({{ value.id }}) {{ value.packageName }}
                                </div>
                              </template>
                              <template #option="{ option }">
                                <span class="select-option-text">
                                  ({{ option.id }}) {{ option.packageName }}
                                </span>
                              </template>
                            </Multiselect>
                          </V-Control>
                        </V-Field>
                      </div>
                      <div class="column is-12">
                        <V-Field>
                          <label>Generate Ticket</label>
                          <V-Control>
                            <V-Radio
                              v-model="generateTicket"
                              value="1"
                              label="Yes"
                              name="outlined_squared_radio"
                              color="success"
                              square
                            />

                            <V-Radio
                              v-model="generateTicket"
                              value="0"
                              label="No"
                              name="outlined_squared_radio"
                              color="primary"
                              square
                            />
                          </V-Control>
                        </V-Field>
                      </div>
                    </div>
                    <div class="button-submit">
                      <V-Button @click="toggleShowMainPackageSection"
                        >Cancel</V-Button
                      >
                      <V-Button
                        color="primary"
                        class="ml-3"
                        @click="addMainPackage"
                        >Add Main Package</V-Button
                      >
                    </div>
                  </div>

                  <AddonPackageForm
                    v-if="showAddonSection"
                    :packages="packages"
                    :all-group-packages="dependOnPackageList"
                    :current-addon-package="currentAddonPackage"
                    @add="addAddonPackage"
                    @cancel="toggleShowAddonPackageSection"
                  />
                </div>
              </div>
            </V-Loader>
          </p>
        </template>
      </V-Tabs>
    </div>
  </div>
</template>

<style lang="scss">
@import '../../scss/abstracts/_variables.scss';
@import '../../scss/abstracts/_mixins.scss';
@import '../../scss/pages/generic/_forms.scss';
.form-fieldset {
  max-width: 540px;
}
.button-submit {
  text-align: end;
}
.package-row-drag {
  cursor: pointer;
  margin-bottom: 1rem;
  .package-detail {
    display: flex;
    align-items: center;
  }
}
</style>
